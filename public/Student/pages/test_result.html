<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title id="result-title">Result</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="../../assets/patternfly/dist/js/patternfly.min.js"></script>

    <!-- C3  -->
    <link rel="stylesheet" href="../../assets/c3/c3.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.12.0/d3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.12.0/d3.min.js"></script>
    <script src="../../assets/c3/c3.min.js"></script>

<style>
.donut_margin {
    display: inline-block;
}





/* ---------------------------------------------------
    SIDEBAR STYLE
----------------------------------------------------- */

.wrapper {
    display: flex;
    width: 100%;
}


#sidebar {
    min-width: 200px;
    max-width: 250px;
    background: #130f40;
    color: #fff;
    transition: all 0.6s cubic-bezier(0.945, 0.020, 0.270, 0.665);
    transform-origin: bottom left;
}

#sidebar.active {
    margin-left: -250px;
    transform: rotateY(100deg);
}

#sidebar .sidebar-header {
    padding: 20px;
    background: #30336b;
}

#sidebar ul.components {
    padding: 20px 0;
}

#sidebar ul p {
    color: #fff;
    padding: 10px;
}
#sidebar ul li a {
    padding: 10px;
    font-size: 1.1em;
    color:white;
    display: block;
}
#sidebar ul li a:hover {
    color:black;
    background: white;
    text-decoration: none;
}

#sidebar ul li.active > a, a[aria-expanded="true"] {
    color: #fff;
    background: #6d7fcc;
}




.dropdown-toggle::after {
    display: block;
    position: absolute;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
}












/* ---------------------------------------------------
    MEDIAQUERIES
----------------------------------------------------- */
@media (max-width: 768px) {
    #sidebar {
        margin-left: -250px;
        transform: rotateY(90deg);
    }
    #sidebar.active {
        margin-left: 0;
        transform: none;
    }
    #sidebarCollapse span:first-of-type,
    #sidebarCollapse span:nth-of-type(2),
    #sidebarCollapse span:last-of-type {
        transform: none;
        opacity: 1;
        margin: 5px auto;
    }
    #sidebarCollapse.active span {
        margin: 0 auto;
    }
    #sidebarCollapse.active span:first-of-type {
        transform: rotate(45deg) translate(2px, 2px);
    }
    #sidebarCollapse.active span:nth-of-type(2) {
        opacity: 0;
    }
    #sidebarCollapse.active span:last-of-type {
        transform: rotate(-45deg) translate(1px, -1px);
    }


}

#overallAnalysisArea {
    margin-left: auto;
    margin-right: auto;
    margin-top: 20px;
    margin-bottom: 10px;
}
</style>
</head>
<body>
<div class="wrapper">
<nav id="sidebar">
    <div class="sidebar-header">
        <h3 id="test_name_header"></h3>
    </div>

    <ul class="list-unstyled components">
        <li class="active">
            <a href="#">Result</a>
        </li>
        <li>
            <a href="subject_analysis.html"> Subject Wise Analysis </a>
        </li>
        <li>
            <a href="section_analysis.html">Section Wise Analysis</a>
            
        </li>
        <li>
            <a href="chapter_analysis.html"> Chapter Wise Analysis </a>
        </li>
        <li>
            <a href="topic_analysis.html"> Topic Wise Analysis </a>
        </li>
        <li>
            <a href="result_answers.html"> Answers </a>
        </li>
    </ul>

</nav>
<div class="content" style="width:100%;height:100%">
    <nav class="navbar navbar-dark bg-dark">
                <a class="navbar-brand" href="#" style="float:right" id="student_marks_navbar"></a>
     </nav>   
    <table id="resultDataTable" class="display" style="width:100%">
    
    </table>

    <button class="btn btn-success" onclick="showAnalysis()"> View Selection Analysis </button>
    <div class="card" style="width: wrap;padding:20px; margin-left:auto;margin-right: auto;">
            <div class="card-header">
                    Overall Analysis
            </div>
            <div class="card-body" style="margin-left: auto;margin-right:auto">
                    <div id="overallAnalysisArea" style="width:wrap">

                    </div>
            </div>
    </div>
    <div id="selectionAnalysisArea" style="padding:10px;"> </div>

</div>
</div>
<script>
var pe_username;
var pe_email;
var result;
var highest_result;
var all_results;
var user_access_token = localStorage.getItem("student_token");
var domain_url = "https://photonecademy.com/tests"
// Related to this page
var student_marks_navbar = document.getElementById("student_marks_navbar");
var resultDataTable = document.getElementById(`resultDataTable`)
var overallAnalysisArea = document.getElementById(`overallAnalysisArea`);
var selectionAnalysisArea = document.getElementById(`selectionAnalysisArea`)
var test_name_header = document.getElementById("test_name_header");
var data_table_header_content = `
<thead>
    <tr> 
        <th> Sr No. </th>
        <th> Q No </th>
        <th> Your Answer </th>
        <th> Marks Scored </th>
        <th> DLevel </th>
        <th> Subject </th>
        <th> Section </th>
        <th> Chapter </th>
        <th> Topic </th>
        <th> % Correct </th>
        <th> % Wrong </th>
        <th> % Unattempted </th>
    </tr>
</thead>

`
var data_table_content=``;

var data_table_fotter_content = `

<tfoot>
            <tr>
                    <th> Sr No. </th>
                    <th> Q No </th>
                    <th> Your Answer </th>
                    <th> Marks Scored </th>
                    <th> DLevel </th>
                    <th> Subject </th>
                    <th> Section </th>
                    <th> Chapter </th>
                    <th> Topic </th>
                    <th> % Correct </th>
                    <th> % Wrong </th>
                    <th> % Unattempted </th>
            </tr>
</tfoot>
`

function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
};
var test_name = getUrlParameter('test_name');
test_name_header.innerHTML=test_name;
fetch(`${domain_url}/verifyStudent`,{
			headers:{
				method:"GET",
				authorization:user_access_token
			}
		}).then(response=>response.json()).then(data=>{
			console.log("is token verified? "+data.is_verified);
			if(data.is_verified==false)
			{
				document.location.href=`${domain_url}`;
			}
			if(data.is_verified==true)
			{
				console.log(data);
				var authDetails = data.student;
				pe_username = authDetails.studentID;
				console.log(` Test Name is ${test_name} and StudentID is ${pe_username}`)
                fetch(`${domain_url}/getSpecificTestResult`,{
                    method:"POST",
                    headers:{
                        authorization:user_access_token,
                        'Content-type':'application/json'
                    },
                    body:JSON.stringify({studentID:pe_username,test_name:test_name})
                }).then(res=>res.json()).then(output=>{
                    console.log(output)
                    if(output.is_successful)
                    {
                        var t_marks = output.result.test_correct_marks * output.result.answers.length;
                        var score = `Your Score : ${output.result.total_marks} / ${t_marks}`
                        result = output.result;
                        test = output.test;
                        student_marks_navbar.innerHTML=score;
                        parsed_all = 0;
                        show_result=0;
                        for(let i=0;i<output.test.questions.length;i++)
                        {
                            var answer;
                            var marks_scored=0;
                            percent_correct = parseFloat((output.test.question_details.questions_stats[i].total_correct/output.test.test_taken_count)*100).toFixed(3);
                            percent_wrong = parseFloat((output.test.question_details.questions_stats[i].total_wrong/output.test.test_taken_count)*100).toFixed(3);
                            percent_unattempted = parseFloat((output.test.question_details.questions_stats[i].total_unattempted/output.test.test_taken_count)*100).toFixed(3);

                            if(output.result.answers[i]==0)
                            {
                                answer="Wrong";
                                marks_scored=marks_scored+output.test.wrong_marks;
                            }
                            else if(output.result.answers[i]==1)
                            {
                                answer="Correct";
                                marks_scored=marks_scored+output.test.correct_marks;
                            }
                            else
                            {
                                answer="Unattempted";
                                marks_scored=0;
                            }
                            data_table_content+=`
                            <tr>
                                <td> ${i+1} </td>
                                <td> Q.${i+1} </td>
                                <td> ${answer} </td>
                                <td> ${marks_scored} </td>
                                <td> ${output.test.questions[i].DLevel} </td>
                                <td> ${output.test.questions[i].subject} </td>
                                <td> ${output.test.questions[i].section} </td>
                                <td> ${output.test.questions[i].chapter} </td>
                                <td> ${output.test.questions[i].topic} </td>
                                <td> ${percent_correct} %</td>
                                <td> ${percent_wrong} %</td>
                                <td> ${percent_unattempted} %</td>
                            </tr>
                            `
                            if(i==output.test.questions.length-1)
                            {
                                parsed_all=1;
                                resultDataTable.innerHTML=`${data_table_header_content}<tbody>${data_table_content}</tbody>${data_table_fotter_content}`;
                                $(`#resultDataTable`).DataTable();
                                show_result=1;
                            }
                        }
                        // Get All Results
                        fetch(`${domain_url}/getAllResults`,{
                            method:"POST",
                            headers:{
                                authorization:user_access_token,
                                'Content-type':'application/json'
                            },
                            body:JSON.stringify({test_name:test_name})
                        }).then(res=>res.json()).then(data=>{
                            console.log(data)
                            if(data.is_successful)
                            {
                                all_results = data.results;
                                          // Get Top Result
                                                fetch(`${domain_url}/getTopResult`,{
                                                    method:"POST",
                                                    headers:{
                                                        authorization:user_access_token,
                                                        'Content-type':'application/json'
                                                    },
                                                    body:JSON.stringify({test_name:test_name})
                                                }).then(res=>res.json()).then(data=>{
                                                    console.log(data)
                                                    if(data.is_successful)
                                                    {
                                                        highest_result = data.topResult;
                                                         // Show Overall Analysis (IMP)
                                                            if(highest_result.length>0)
                                                            {
                                                            // User Percentages
                                                                percentage_correct_user = parseFloat((result.total_correct/test.questions.length)*100).toFixed(3)
                                                                percentage_wrong_user = parseFloat((result.total_wrong/test.questions.length)*100).toFixed(3)
                                                                percentage_unattempted_user = parseFloat((result.total_unattempted/test.questions.length)*100).toFixed(3)
                                                            // Highest Percentages
                                                                percentage_correct_highest = parseFloat((highest_result[0].total_correct/test.questions.length)*100).toFixed(3)
                                                                percentage_wrong_highest = parseFloat((highest_result[0].total_wrong/test.questions.length)*100).toFixed(3)
                                                                percentage_unattempted_highest = parseFloat((highest_result[0].total_unattempted/test.questions.length)*100).toFixed(3)
                                                            //  Average Percentages
                                                                total_correct_average = 0;
                                                                total_wrong_average = 0;
                                                                total_unattempted_average = 0;
                                                                test.question_details.questions_stats.forEach(question=>{
                                                                    total_correct_average += question.total_correct;
                                                                    total_wrong_average += question.total_wrong;
                                                                    total_unattempted_average += question.total_unattempted;
                                                                })

                                                                percentage_correct_average = parseFloat((total_correct_average/(test.test_taken_count*test.questions.length)*100)).toFixed(3)
                                                                percentage_wrong_average = parseFloat((total_wrong_average/(test.test_taken_count*test.questions.length)*100)).toFixed(3)
                                                                percentage_unattempted_average = parseFloat((total_unattempted_average/(test.test_taken_count*test.questions.length)*100)).toFixed(3)

                                                                overallAnalysisArea.innerHTML=`
                                                                <div class="progress_container">
                                                                <div class="progress-description">
                                                                Highest Performance
                                                                </div>
                                                                <div class="progress progress-label-top-right" style="height:20px;">
                                                                <div class="progress-bar unselectable"  role="progressbar" aria-valuenow="${percentage_correct_highest}" aria-valuemin="0" aria-valuemax="100" style="width: ${percentage_correct_highest}%;background-color:#02006D"  data-toggle="tooltip" title="${percentage_correct_highest}% Correct">
                                                                    <span><strong>${percentage_correct_highest} % </strong> Correct </span>
                                                                </div>
                                                                <div class="progress-bar unselectable"  role="progressbar" aria-valuenow="${percentage_unattempted_highest}" aria-valuemin="0" aria-valuemax="100" style="width: ${percentage_unattempted_highest}%;background-color:#55DAFD"  data-toggle="tooltip" title="${percentage_unattempted_highest}% Unattempted">
                                                                    <span><strong>${percentage_unattempted_highest} % </strong> Unattempted </span>
                                                                </div>
                                                                <div class="progress-bar unselectable"  role="progressbar" aria-valuenow="${percentage_wrong_highest}" aria-valuemin="0" aria-valuemax="100" style="width: ${percentage_wrong_highest}%;background-color:#6F00FF"  data-toggle="tooltip" title="${percentage_wrong_highest}% Wrong">
                                                                    <span><strong>${percentage_wrong_highest} % </strong> Wrong </span>
                                                                </div>
                                                                </div>
                                                                </div>
                                                                <div id="usersPerformance" class="progress_container">
                                                                <div class="progress-description" >
                                                                Your Performance
                                                                </div>
                                                                <div class="progress progress-label-top-right" style="height:20px" >
                                                                <div class="progress-bar unselectable"  role="progressbar" aria-valuenow="${percentage_correct_user}" aria-valuemin="0" aria-valuemax="100" style="width: ${percentage_correct_user}%;background-color:#02006D"  data-toggle="tooltip" title="${percentage_correct_user}% Correct">
                                                                    <span><strong>${percentage_correct_user} % </strong> Correct </span>
                                                                </div>
                                                                <div class="progress-bar unselectable"  role="progressbar" aria-valuenow="${percentage_unattempted_user}" aria-valuemin="0" aria-valuemax="100" style="width: ${percentage_unattempted_user}%;background-color:#55DAFD"  data-toggle="tooltip" title="${percentage_unattempted_user}% Unattempted">
                                                                    <span><strong>${percentage_unattempted_user} % </strong> Unattempted </span>
                                                                </div>
                                                                <div class="progress-bar unselectable"  role="progressbar" aria-valuenow="${percentage_wrong_user}" aria-valuemin="0" aria-valuemax="100" style="width: ${percentage_wrong_user}%;background-color:#6F00FF"  data-toggle="tooltip" title="${percentage_wrong_user}% Wrong">
                                                                    <span><strong>${percentage_wrong_user} % </strong> Wrong </span>
                                                                </div>
                                                                </div>
                                                                </div>
                                                                <div class="progress_container">
                                                                <div class="progress-description">
                                                                Average Performance
                                                                </div>
                                                                <div class="progress progress-label-top-right" style="height:20px">
                                                                <div class="progress-bar unselectable"  role="progressbar" aria-valuenow="${percentage_correct_average}" aria-valuemin="0" aria-valuemax="100" style="width: ${percentage_correct_average}%;background-color:#02006D"  data-toggle="tooltip" title="${percentage_correct_average}% Correct">
                                                                    <span><strong>${percentage_correct_average} % </strong> Correct </span>
                                                                </div>
                                                                <div class="progress-bar unselectable"  role="progressbar" aria-valuenow="${percentage_unattempted_average}" aria-valuemin="0" aria-valuemax="100" style="width: ${percentage_unattempted_average}%;background-color:#55DAFD"  data-toggle="tooltip" title="${percentage_unattempted_average}% Unattempted">
                                                                    <span><strong>${percentage_unattempted_average} % </strong> Unattempted </span>
                                                                </div>
                                                                <div class="progress-bar unselectable"  role="progressbar" aria-valuenow="${percentage_wrong_average}" aria-valuemin="0" aria-valuemax="100" style="width: ${percentage_wrong_average}%;background-color:#6F00FF"  data-toggle="tooltip" title="${percentage_wrong_user}% Wrong">
                                                                    <span><strong>${percentage_wrong_average} % </strong> Wrong </span>
                                                                </div>
                                                                </div>
                                                                </div>
                                                                </div>

                                                                
                                                                <div id="donut-chart-overall-user"  class="donut_margin donut_other_margins"></div>
                                                                <div id="donut-chart-overall-average"  class="donut_margin donut_other_margins"></div>
                                                                <div id="donut-chart-overall-highest"  class="donut_margin donut_other_margins"></div>

                                                                `
                                                                 //// DONUT CHARTS CONFIGURATION

                                                                        // For User 
                                                                        var c3ChartDefaults = $().c3ChartDefaults();
                                                                        var donutData = {
                                                                        type : 'donut',
                                                                        columns: [
                                                                            ['% Correct', percentage_correct_user],
                                                                            ['% Unattempted', percentage_unattempted_user],
                                                                            ['% Wrong', percentage_wrong_user]
                                                                        ],
                                                                      
                                                                        };
                                                                    
                                                                        // Right Legend
                                                                        var donutChartRightConfig = c3ChartDefaults.getDefaultRelationshipDonutConfig();
                                                                        donutChartRightConfig.bindto = '#donut-chart-overall-user';
                                                                        donutChartRightConfig.tooltip = {show: true};
                                                                        donutChartRightConfig.data = donutData;
                                                                        donutChartRightConfig.legend = {
                                                                        show: true,
                                                                        position: 'right'
                                                                        };
                                                                        donutChartRightConfig.size = {
                                                                        width: 251,
                                                                        height: 161
                                                                        };
                                                                        donutChartRightConfig.tooltip = {
                                                                        contents: $().pfDonutTooltipContents
                                                                        };

                                                                        var donutChartRightLegend = c3.generate(donutChartRightConfig);
                                                                        $().pfSetDonutChartTitle("#donut-chart-overall-user", "User");
                                                                        // For Average
                                                                        var c3ChartDefaults = $().c3ChartDefaults();
                                                                        var donutData = {
                                                                        type : 'donut',
                                                                        columns: [
                                                                            ['% Correct', percentage_correct_average],
                                                                            ['% Unattempted', percentage_unattempted_average],
                                                                            ['% Wrong', percentage_wrong_average]
                                                                        ],
                                                                   
                                                                        };
                                                                    
                                                                        // Right Legend
                                                                        var donutChartRightConfig = c3ChartDefaults.getDefaultRelationshipDonutConfig();
                                                                        donutChartRightConfig.bindto = '#donut-chart-overall-average';
                                                                        donutChartRightConfig.tooltip = {show: true};
                                                                        donutChartRightConfig.data = donutData;
                                                                        donutChartRightConfig.legend = {
                                                                        show: true,
                                                                        position: 'right'
                                                                        };
                                                                        donutChartRightConfig.size = {
                                                                        width: 251,
                                                                        height: 161
                                                                        };
                                                                        donutChartRightConfig.tooltip = {
                                                                        contents: $().pfDonutTooltipContents
                                                                        };

                                                                        var donutChartRightLegend = c3.generate(donutChartRightConfig);
                                                                        $().pfSetDonutChartTitle("#donut-chart-overall-average", "Average");
                                                                        // For Highest
                                                                        var c3ChartDefaults = $().c3ChartDefaults();
                                                                        var donutData = {
                                                                        type : 'donut',
                                                                        columns: [
                                                                            ['% Correct', percentage_correct_highest],
                                                                            ['% Unattempted', percentage_unattempted_highest],
                                                                            ['% Wrong', percentage_wrong_highest]
                                                                        ],
                                                                   
                                                                        };
                                                                    
                                                                        // Right Legend
                                                                        var donutChartRightConfig = c3ChartDefaults.getDefaultRelationshipDonutConfig();
                                                                        donutChartRightConfig.bindto = '#donut-chart-overall-highest';
                                                                        donutChartRightConfig.tooltip = {show: true};
                                                                        donutChartRightConfig.data = donutData;
                                                                        donutChartRightConfig.legend = {
                                                                        show: true,
                                                                        position: 'right'
                                                                        };
                                                                        donutChartRightConfig.size = {
                                                                        width: 251,
                                                                        height: 161
                                                                        };
                                                                        donutChartRightConfig.tooltip = {
                                                                        contents: $().pfDonutTooltipContents
                                                                        };

                                                                        var donutChartRightLegend = c3.generate(donutChartRightConfig);
                                                                        $().pfSetDonutChartTitle("#donut-chart-overall-highest", "Highest");

                                                            }
                                                    }
                                                    else
                                                    {
                                                        console.log("FAILED TO GET RESULTS")
                                                    }
                                                })
                            }
                            else
                            {
                                console.log("FAILED TO GET RESULTS")
                            }
                        })
              


                        

                    }
                    else
                    {
                        alert("Failed to get result")
                    }
                })
			}
        })
        
                       
</script>
</body>
</html>